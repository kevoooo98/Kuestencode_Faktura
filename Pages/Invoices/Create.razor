@page "/invoices/create"
@using InvoiceApp.Services
@using InvoiceApp.Models
@inject IInvoiceService InvoiceService
@inject ICustomerService CustomerService
@inject ICompanyService CompanyService
@inject IEmailService EmailService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Neue Faktura - Küstencode Faktura</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h4" GutterBottom="true">Neue Faktura</MudText>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="my-4">@_errorMessage</MudAlert>
        }

        <EditForm Model="@_invoice">
            <DataAnnotationsValidator />

            <!-- Kopfdaten -->
            <MudText Typo="Typo.h6" Class="mt-4 mb-2">Kopfdaten</MudText>
            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudTextField Label="Rechnungsnummer" @bind-Value="_invoice.InvoiceNumber"
                                 For="@(() => _invoice.InvoiceNumber)" ReadOnly="true" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="Rechnungsdatum" @bind-Date="_invoiceDate"
                                  DateFormat="dd.MM.yyyy" Required="true" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="Fälligkeitsdatum" @bind-Date="_dueDate"
                                  DateFormat="dd.MM.yyyy" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudDatePicker Label="Leistungszeitraum Von" @bind-Date="_servicePeriodStart"
                                  DateFormat="dd.MM.yyyy"
                                  HelperText="Beginn der Leistungserbringung" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudDatePicker Label="Leistungszeitraum Bis" @bind-Date="_servicePeriodEnd"
                                  DateFormat="dd.MM.yyyy"
                                  HelperText="Ende der Leistungserbringung" />
                </MudItem>
                <MudItem xs="12">
                    <MudAutocomplete T="Customer"
                        Label="Kunde auswählen"
                        @bind-Value="_selectedCustomer"
                        SearchFunc="@SearchCustomers"
                        ToStringFunc="@(c => c?.Name ?? string.Empty)"
                        ResetValueOnEmptyText="true"
                        CoerceText="true"
                        CoerceValue="false"
                        Error="@_customerError"
                        ErrorText="@_customerErrorText"
                        @ref="_customerAuto">
                        <ItemTemplate Context="customer">
                            <MudText>@customer.Name</MudText>
                            <MudText Typo="Typo.caption">@customer.CustomerNumber - @customer.City</MudText>
                        </ItemTemplate>
                    </MudAutocomplete>
                </MudItem>
            </MudGrid>

            <!-- Positionen -->
            <MudText Typo="Typo.h6" Class="mt-6 mb-2">Positionen</MudText>
            <MudTable Items="@_invoice.Items" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>Beschreibung</MudTh>
                    <MudTh Style="width: 120px; text-align: right">Menge</MudTh>
                    <MudTh Style="width: 120px; text-align: right">Einzelpreis</MudTh>
                    <MudTh Style="width: 120px; text-align: right">Gesamt</MudTh>
                    <MudTh Style="width: 60px"></MudTh>
                </HeaderContent>
                <RowTemplate Context="item">
                    <MudTd DataLabel="Beschreibung">
                        <MudTextField @bind-Value="item.Description" Margin="Margin.Dense"
                                     Variant="Variant.Outlined" Required="true"
                                     OnBlur="RecalculateTotals" />
                    </MudTd>
                    <MudTd DataLabel="Menge" Style="text-align: right">
                        <MudNumericField @bind-Value="item.Quantity" Margin="Margin.Dense"
                                        Variant="Variant.Outlined" Min="0.001m" Step="1m"
                                        Format="N3" HideSpinButtons="true"
                                        OnBlur="RecalculateTotals" />
                    </MudTd>
                    <MudTd DataLabel="Einzelpreis" Style="text-align: right">
                        <MudNumericField @bind-Value="item.UnitPrice" Margin="Margin.Dense"
                                        Variant="Variant.Outlined" Min="0.01m" Step="1m"
                                        Format="C2" HideSpinButtons="true" Culture="@_culture"
                                        OnBlur="RecalculateTotals" />
                    </MudTd>
                    <MudTd DataLabel="Gesamt" Style="text-align: right">
                        <MudText Typo="Typo.body2">@item.TotalNet.ToString("C2", _culture)</MudText>
                    </MudTd>
                    <MudTd DataLabel="">
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                      Color="Color.Error" OnClick="@(() => RemoveItem(item))"
                                      Disabled="@(_invoice.Items.Count <= 1)" />
                    </MudTd>
                </RowTemplate>
            </MudTable>

            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                      StartIcon="@Icons.Material.Filled.Add" OnClick="AddItem" Class="mt-2">
                Position hinzufügen
            </MudButton>

            <!-- Summen -->
            <MudPaper Elevation="2" Class="pa-4 mt-6" Style="max-width: 400px; margin-left: auto;">
                <MudText Typo="Typo.h6" GutterBottom="true">Summen</MudText>
                <MudStack Spacing="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText>Nettosumme:</MudText>
                        <MudText>@_totalNet.ToString("C2", _culture)</MudText>
                    </MudStack>
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText>@(_company?.IsKleinunternehmer == true ? "MwSt (0%):" : "MwSt (19%):")</MudText>
                        <MudText>@_totalVat.ToString("C2", _culture)</MudText>
                    </MudStack>
                    <MudDivider />
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.h6">Bruttosumme:</MudText>
                        <MudText Typo="Typo.h6">@_totalGross.ToString("C2", _culture)</MudText>
                    </MudStack>
                    @if (_company?.IsKleinunternehmer == true)
                    {
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                            §19 UStG - Kleinunternehmer (keine MwSt)
                        </MudAlert>
                    }
                </MudStack>
            </MudPaper>

            <!-- Notizen -->
            <MudText Typo="Typo.h6" Class="mt-6 mb-2">Notizen (optional)</MudText>
            <MudTextField @bind-Value="_invoice.Notes" Lines="4" Variant="Variant.Outlined" />

            <!-- Actions -->
            <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-6 gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Default" OnClick="Cancel">
                    Abbrechen
                </MudButton>

                <MudButton Variant="Variant.Filled" Color="Color.Secondary"
                        Disabled="@_saving"
                        OnClick="@(() => SaveAsync(true))">
                    Als Entwurf speichern
                </MudButton>

                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                        Disabled="@_saving"
                        OnClick="@(() => SaveAndSendAsync(false))">
                    @if (_saving)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Speichert...</MudText>
                    }
                    else
                    {
                        <MudText>Faktura versenden</MudText>
                    }
                </MudButton>
            </MudStack>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private bool _customerError;
    private string? _customerErrorText;
    private MudAutocomplete<Customer>? _customerAuto;
    private Invoice _invoice = new();
    private Customer? _selectedCustomer;
    private Company? _company;
    private List<Customer> _customers = new();
    private DateTime? _invoiceDate = DateTime.Today;
    private DateTime? _servicePeriodStart;
    private DateTime? _servicePeriodEnd;
    private DateTime? _dueDate = DateTime.Today.AddDays(14);
    private bool _saving = false;
    private string? _errorMessage;
    private decimal _totalNet, _totalVat, _totalGross;
    private System.Globalization.CultureInfo _culture = new System.Globalization.CultureInfo("de-DE");

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _invoice.InvoiceNumber = await InvoiceService.GenerateInvoiceNumberAsync();
            _customers = await CustomerService.GetAllAsync();
            _company = await CompanyService.GetCompanyAsync();
            AddItem();
            RecalculateTotals();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Fehler beim Initialisieren: {ex.Message}";
        }
    }

    private async Task<IEnumerable<Customer>> SearchCustomers(string value, CancellationToken token)
    {
        await Task.CompletedTask; // Async compatibility

        if (string.IsNullOrWhiteSpace(value))
            return _customers;

        return _customers.Where(c =>
            c.Name.Contains(value, StringComparison.OrdinalIgnoreCase) ||
            c.CustomerNumber.Contains(value, StringComparison.OrdinalIgnoreCase)
        );
    }

    private void AddItem()
    {
        var vatRate = _company?.IsKleinunternehmer == true ? 0 : 19;
        _invoice.Items.Add(new InvoiceItem
        {
            Quantity = 1,
            UnitPrice = 0,
            VatRate = vatRate
        });
    }

    private void RemoveItem(InvoiceItem item)
    {
        if (_invoice.Items.Count > 1)
        {
            _invoice.Items.Remove(item);
            RecalculateTotals();
        }
    }

    private void RecalculateTotals()
    {
        // Ensure all items have the correct VAT rate based on company settings
        var vatRate = _company?.IsKleinunternehmer == true ? 0 : 19;
        foreach (var item in _invoice.Items)
        {
            item.VatRate = vatRate;
        }

        _totalNet = _invoice.Items.Sum(i => i.TotalNet);
        _totalVat = _invoice.Items.Sum(i => i.TotalVat);
        _totalGross = _invoice.Items.Sum(i => i.TotalGross);
        StateHasChanged();
    }

    private async Task<bool> ValidateInvoiceAsync()
    {
        _customerError = false;
        _customerErrorText = null;
        _errorMessage = null;

        // Regel: Kunde ist Pflicht
        if (_selectedCustomer == null)
        {
            _customerError = true;
            _customerErrorText = "Kunde auswählen";

            if (_customerAuto is not null)
                await _customerAuto.FocusAsync();

            return false;
        }

        // Positionen: Pflicht
        if ((_invoice.Items.Count == 0 || _invoice.Items.All(i => string.IsNullOrWhiteSpace(i.Description))))
        {
            _errorMessage = "Mindestens eine Position angeben.";
            return false;
        }

        if (_invoice.Items.Any(i => i.Quantity <= 0 || i.UnitPrice < 0))
        {
            _errorMessage = "Menge muss > 0 sein und Preis darf nicht negativ sein.";
            return false;
        }

        // Rechnungsdatum: Pflicht
        if (_invoiceDate == null)
        {
            _errorMessage = "Rechnungsdatum fehlt.";
            return false;
        }

        if (_invoiceDate.Value > DateTime.Today)
        {
            _errorMessage = "Rechnungsdatum darf nicht in der Zukunft liegen.";
            return false;
        }

        return true;
    }

    private async Task SaveAsync(bool asDraft)
    {
        if (!await ValidateInvoiceAsync())
            return;

        _saving = true;

        try
        {
            if (_selectedCustomer != null)
                _invoice.CustomerId = _selectedCustomer.Id;

            _invoice.InvoiceDate = DateTime.SpecifyKind(_invoiceDate.Value, DateTimeKind.Utc);
            _invoice.ServicePeriodStart = _servicePeriodStart.HasValue ? DateTime.SpecifyKind(_servicePeriodStart.Value, DateTimeKind.Utc) : null;
            _invoice.ServicePeriodEnd   = _servicePeriodEnd.HasValue ? DateTime.SpecifyKind(_servicePeriodEnd.Value, DateTimeKind.Utc) : null;
            _invoice.DueDate            = _dueDate.HasValue ? DateTime.SpecifyKind(_dueDate.Value, DateTimeKind.Utc) : null;

            _invoice.Status = asDraft ? InvoiceStatus.Draft : InvoiceStatus.Sent;

            await InvoiceService.CreateAsync(_invoice);

            Snackbar.Add($"Rechnung {_invoice.InvoiceNumber} wurde erfolgreich erstellt.",
                Severity.Success);

            NavigationManager.NavigateTo("/invoices");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Fehler beim Speichern: {ex.Message}";
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task SaveAndSendAsync(bool asDraft = false)
    {
        if (!await ValidateInvoiceAsync())
            return;

        // E-Mail-Konfiguration prüfen
        var isEmailConfigured = await CompanyService.IsEmailConfiguredAsync();
        if (!isEmailConfigured)
        {
            _errorMessage = "E-Mail-Versand ist nicht konfiguriert. Bitte richten Sie zuerst die E-Mail-Einstellungen ein.";
            return;
        }

        _saving = true;

        try
        {
            if (_selectedCustomer != null)
                _invoice.CustomerId = _selectedCustomer.Id;

            _invoice.InvoiceDate = DateTime.SpecifyKind(_invoiceDate.Value, DateTimeKind.Utc);
            _invoice.ServicePeriodStart = _servicePeriodStart.HasValue ? DateTime.SpecifyKind(_servicePeriodStart.Value, DateTimeKind.Utc) : null;
            _invoice.ServicePeriodEnd   = _servicePeriodEnd.HasValue ? DateTime.SpecifyKind(_servicePeriodEnd.Value, DateTimeKind.Utc) : null;
            _invoice.DueDate            = _dueDate.HasValue ? DateTime.SpecifyKind(_dueDate.Value, DateTimeKind.Utc) : null;

            _invoice.Status = InvoiceStatus.Sent;

            var createdInvoice = await InvoiceService.CreateAsync(_invoice);

            Snackbar.Add($"Rechnung {_invoice.InvoiceNumber} wurde erfolgreich erstellt.", Severity.Success);

            // E-Mail-Dialog öffnen
            await OpenEmailDialog(createdInvoice);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Fehler beim Speichern: {ex.Message}";
            _saving = false;
        }
    }

    private async Task OpenEmailDialog(Invoice invoice)
    {
        var parameters = new DialogParameters<SendEmailDialog>
        {
            { x => x.Invoice, invoice },
            { x => x.CustomerEmail, _selectedCustomer?.Email },
            { x => x.OnSend, EventCallback.Factory.Create<(string Email, string? Message, EmailAttachmentFormat Format)>(this, SendInvoiceEmail) }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<SendEmailDialog>("E-Mail versenden", parameters, options);
        var result = await dialog.Result;

        // Nach dem Dialog zurück zur Rechnungsliste
        if (!result.Canceled || result.Canceled)
        {
            _saving = false;
            NavigationManager.NavigateTo("/invoices");
        }
    }

    private async Task SendInvoiceEmail((string Email, string? Message, EmailAttachmentFormat Format) data)
    {
        if (_invoice == null) return;

        try
        {
            var success = await EmailService.SendInvoiceEmailAsync(
                _invoice.Id,
                data.Email,
                data.Message,
                data.Format);

            if (success)
            {
                var formatText = data.Format switch
                {
                    EmailAttachmentFormat.ZugferdPdf => " als ZUGFeRD-PDF",
                    EmailAttachmentFormat.XRechnungXmlOnly => " als XRechnung-XML",
                    EmailAttachmentFormat.XRechnungXmlAndPdf => " als XRechnung (XML + PDF)",
                    _ => ""
                };

                Snackbar.Add(
                    $"Rechnung {_invoice.InvoiceNumber}{formatText} wurde erfolgreich an {data.Email} versendet.",
                    Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Versenden der E-Mail: {ex.Message}", Severity.Error);
            throw;
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/invoices");
    }
}
